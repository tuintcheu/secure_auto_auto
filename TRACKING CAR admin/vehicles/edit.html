<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Modifier un véhicule - TRACKING CAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="../assets/css/style.css">
  </head>
  <body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 fixed w-full top-0 z-40">
      <div class="px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <div class="flex items-center ml-2">
              <div class="h-8 w-8 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-shield-alt text-white text-sm"></i>
              </div>
              <h1 class="text-xl font-bold text-gray-900">TRACKING CAR</h1>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <div class="relative">
              <button id="userMenuBtn" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                  <i class="fas fa-user text-blue-600"></i>
                </div>
                <div class="hidden md:block text-left">
                  <div id="userName" class="text-sm font-medium text-gray-900">Admin</div>
                  <div id="userRole" class="text-xs text-gray-500">Administrateur</div>
                </div>
              </button>
              
              <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1">
                <button id="logoutBtn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                  <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="lg:ml-64 pt-16">
      <div class="p-6">
        <!-- Breadcrumb -->
        <nav class="flex mb-6" aria-label="Breadcrumb">
          <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
              <a href="../dashboard.html" class="text-gray-700 hover:text-blue-600">Tableau de bord</a>
            </li>
            <li>
              <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <a href="list.html" class="text-gray-700 hover:text-blue-600">Véhicules volés</a>
              </div>
            </li>
            <li aria-current="page">
              <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <span class="text-blue-600 font-medium">Modifier un véhicule</span>
              </div>
            </li>
          </ol>
        </nav>

        <div class="mb-6">
          <h1 class="text-2xl font-bold text-gray-900 mb-2">
            Modifier un véhicule volé
          </h1>
        </div>

        <!-- Formulaire d'édition -->
        <form id="editVehicleForm" class="space-y-6">
          <!-- Informations sur le véhicule volé -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-white bg-blue-600 px-4 py-2 rounded-md mb-6 flex items-center">
              <i class="fas fa-car-crash text-white mr-2"></i>
              Informations sur le véhicule volé
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="form-group">
                <label for="registrationNumber" class="form-label">
                  <i class="fas fa-hashtag mr-1"></i>Numéro d'enregistrement *
                </label>
                <input
                  type="text"
                  id="registrationNumber"
                  name="registrationNumber"
                  class="form-input"
                  disabled
                />
              </div>

              <div class="form-group">
                <label for="theftDate" class="form-label">
                  <i class="far fa-calendar-alt mr-1"></i>Date du vol *
                </label>
                <input
                  type="date"
                  id="theftDate"
                  name="theftDate"
                  required
                  class="form-input"
                />
              </div>

              <div class="form-group">
                <label for="theftTime" class="form-label">
                  <i class="far fa-clock mr-1"></i>Heure du vol
                </label>
                <input
                  type="time"
                  id="theftTime"
                  name="theftTime"
                  class="form-input"
                />
              </div>

              <div class="form-group md:col-span-2">
                <label for="theftLocation" class="form-label">
                  <i class="fas fa-map-marker-alt mr-1"></i>Lieu du vol *
                </label>
                <input
                  type="text"
                  id="theftLocation"
                  name="theftLocation"
                  required
                  class="form-input"
                  placeholder="Ville, quartier, rue..."
                />
              </div>

              <div class="form-group">
                <label class="form-label block mb-2">
                  <i class="fas fa-car-side mr-1"></i>Type de véhicule *
                </label>
                <div class="space-y-2">
                  <label class="inline-flex items-center">
                    <input type="checkbox" name="vehicleType" value="voiture" class="form-checkbox">
                    <span class="ml-2">Voiture</span>
                  </label>
                  <label class="inline-flex items-center ml-4">
                    <input type="checkbox" name="vehicleType" value="moto" class="form-checkbox">
                    <span class="ml-2">Moto</span>
                  </label>
                  <label class="inline-flex items-center ml-4">
                    <input type="checkbox" name="vehicleType" value="camion" class="form-checkbox">
                    <span class="ml-2">Camion</span>
                  </label>
                  <label class="inline-flex items-center ml-4">
                    <input type="checkbox" name="vehicleType" value="autre" class="form-checkbox">
                    <span class="ml-2">Autre</span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label for="make" class="form-label">
                  <i class="fas fa-car mr-1"></i>Marque *
                </label>
                <input
                  type="text"
                  id="make"
                  name="make"
                  required
                  class="form-input"
                  placeholder="Marque du véhicule"
                />
              </div>

              <div class="form-group">
                <label for="model" class="form-label">
                  <i class="fas fa-car-side mr-1"></i>Modèle *
                </label>
                <input
                  type="text"
                  id="model"
                  name="model"
                  required
                  class="form-input"
                  placeholder="Modèle du véhicule"
                />
              </div>

              <div class="form-group">
                <label for="year" class="form-label">
                  <i class="fas fa-calendar mr-1"></i>Année de fabrication *
                </label>
                <input
                  type="number"
                  id="year"
                  name="year"
                  min="1900"
                  max="2025"
                  required
                  class="form-input"
                  placeholder="Année"
                />
              </div>

              <div class="form-group">
                <label for="color" class="form-label">
                  <i class="fas fa-palette mr-1"></i>Couleur *
                </label>
                <select
                  id="color"
                  name="color"
                  required
                  class="form-input form-select"
                >
                  <option value="">Sélectionner la couleur</option>
                  <option value="Blanc">Blanc</option>
                  <option value="Noir">Noir</option>
                  <option value="Gris">Gris</option>
                  <option value="Rouge">Rouge</option>
                  <option value="Bleu">Bleu</option>
                  <option value="Vert">Vert</option>
                  <option value="Jaune">Jaune</option>
                  <option value="Orange">Orange</option>
                  <option value="Marron">Marron</option>
                  <option value="Argent">Argent</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>

              <div class="form-group">
                <label for="licensePlate" class="form-label">
                  <i class="fas fa-tag mr-1"></i>Plaque d'immatriculation *
                </label>
                <input
                  type="text"
                  id="licensePlate"
                  name="licensePlate"
                  required
                  class="form-input"
                  placeholder="Ex: CE 1234 AB"
                />
              </div>

              <div class="form-group">
                <label for="chassisNumber" class="form-label">
                  <i class="fas fa-barcode mr-1"></i>Numéro de châssis *
                </label>
                <input
                  type="text"
                  id="chassisNumber"
                  name="chassisNumber"
                  required
                  class="form-input"
                  placeholder="Numéro VIN ou châssis"
                />
              </div>

              <div class="form-group">
                <label for="engineNumber" class="form-label">
                  <i class="fas fa-cog mr-1"></i>Numéro de moteur
                </label>
                <input
                  type="text"
                  id="engineNumber"
                  name="engineNumber"
                  class="form-input"
                  placeholder="Numéro de série du moteur"
                />
              </div>

              <div class="form-group">
                <label for="estimatedValue" class="form-label">
                  <i class="fas fa-tag mr-1"></i>Valeur estimée (FCFA)
                </label>
                <input
                  type="number"
                  id="estimatedValue"
                  name="estimatedValue"
                  class="form-input"
                  placeholder="Montant estimé"
                />
              </div>

              <div class="form-group">
                <label for="administration" class="form-label">
                  <i class="fas fa-building mr-1"></i>Administration
                </label>
                <input
                  type="text"
                  id="administration"
                  name="administration"
                  class="form-input"
                  placeholder="Ex: Police, Gendarmerie..."
                />
              </div>

              <div class="form-group">
                <label class="form-label block mb-2">
                  <i class="fas fa-map-marked-alt mr-1"></i>Type de zone *
                </label>
                <div class="space-x-4">
                  <label class="inline-flex items-center">
                    <input type="radio" name="zoneType" value="urbaine" class="form-radio" required>
                    <span class="ml-2">Urbaine</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="radio" name="zoneType" value="rurale" class="form-radio">
                    <span class="ml-2">Rurale</span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label block mb-2">
                  <i class="fas fa-eye mr-1"></i>Visibilité *
                </label>
                <div class="space-x-4">
                  <label class="inline-flex items-center">
                    <input type="radio" name="visibility" value="visible" class="form-radio" required>
                    <span class="ml-2">Visible</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="radio" name="visibility" value="caché" class="form-radio">
                    <span class="ml-2">Caché</span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label block mb-2">
                  <i class="fas fa-shield-alt mr-1"></i>Antivol *
                </label>
                <div class="space-x-4">
                  <label class="inline-flex items-center">
                    <input type="radio" name="hasAntitheft" value="oui" class="form-radio" required>
                    <span class="ml-2">Oui</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="radio" name="hasAntitheft" value="non" class="form-radio">
                    <span class="ml-2">Non</span>
                  </label>
                </div>
              </div>

              <div id="antitheftTypeContainer" class="form-group hidden">
                <label for="antitheftType" class="form-label">
                  <i class="fas fa-lock mr-1"></i>Type d'antivol
                </label>
                <select id="antitheftType" name="antitheftType" class="form-input form-select">
                  <option value="">Sélectionner un type</option>
                  <option value="electronique">Électronique</option>
                  <option value="mecanique">Mécanique</option>
                  <option value="gps">GPS</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label block mb-2">
                  <i class="fas fa-check-circle mr-1"></i>Véhicule retrouvé
                </label>
                <div class="space-x-4">
                  <label class="inline-flex items-center">
                    <input type="radio" name="isFound" value="oui" class="form-radio" onchange="toggleFoundFields()">
                    <span class="ml-2">Oui</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input type="radio" name="isFound" value="non" class="form-radio" onchange="toggleFoundFields()" checked>
                    <span class="ml-2">Non</span>
                  </label>
                </div>
              </div>

              <div id="foundDateContainer" class="form-group hidden">
                <label for="foundDate" class="form-label">
                  <i class="far fa-calendar-check mr-1"></i>Date de retrouvaille
                </label>
                <input
                  type="date"
                  id="foundDate"
                  name="foundDate"
                  class="form-input"
                />
              </div>

              <div id="foundConditionContainer" class="form-group hidden md:col-span-2">
                <label for="foundCondition" class="form-label">
                  <i class="fas fa-car-crash mr-1"></i>État lors de la retrouvaille
                </label>
                <select id="foundCondition" name="foundCondition" class="form-input form-select">
                  <option value="">Sélectionner un état</option>
                  <option value="bon">Bon état</option>
                  <option value="endommage">Endommagé</option>
                  <option value="vandalise">Vandalisé</option>
                  <option value="brise">Brisé</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <div id="recoveryDelayContainer" class="form-group hidden">
                <label for="recoveryDelay" class="form-label">
                  <i class="fas fa-clock mr-1"></i>Délai de récupération
                </label>
                <div class="relative">
                  <input
                    type="number"
                    id="recoveryDelay"
                    name="recoveryDelay"
                    class="form-input pr-12"
                    placeholder="0"
                    min="0"
                  />
                  <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                    <span class="text-gray-500">jours</span>
                  </div>
                </div>
              </div>

              <div class="form-group md:col-span-2">
                <label for="distinctiveFeatures" class="form-label">
                  <i class="fas fa-star mr-1"></i>Caractéristiques distinctives
                </label>
                <textarea
                  id="distinctiveFeatures"
                  name="distinctiveFeatures"
                  class="form-input"
                  rows="3"
                  placeholder="Décrivez les caractéristiques distinctives du véhicule (autocollants, rayures, accessoires particuliers, etc.)"
                ></textarea>
              </div>

              <!-- Informations sur le propriétaire -->
              <div class="form-group md:col-span-2 mt-6 pt-6 border-t border-gray-200">
                <h4 class="text-md font-semibold text-white bg-green-600 px-4 py-2 rounded-md mb-4">
                  <i class="fas fa-user-tie text-white mr-2"></i>Informations sur le propriétaire
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="form-group">
                    <label for="ownerLastName" class="form-label">
                      <i class="fas fa-user mr-1"></i>Nom *
                    </label>
                    <input
                      type="text"
                      id="ownerLastName"
                      name="ownerLastName"
                      required
                      class="form-input"
                      placeholder="Nom du propriétaire"
                    />
                  </div>

                  <div class="form-group">
                    <label for="ownerFirstName" class="form-label">
                      <i class="fas fa-user mr-1"></i>Prénom *
                    </label>
                    <input
                      type="text"
                      id="ownerFirstName"
                      name="ownerFirstName"
                      required
                      class="form-input"
                      placeholder="Prénom du propriétaire"
                    />
                  </div>

                  <div class="form-group md:col-span-2">
                    <label for="ownerAddress" class="form-label">
                      <i class="fas fa-map-marker-alt mr-1"></i>Adresse
                    </label>
                    <input
                      type="text"
                      id="ownerAddress"
                      name="ownerAddress"
                      class="form-input"
                      placeholder="Adresse complète du propriétaire"
                    />
                  </div>

                  <div class="form-group">
                    <label for="ownerPhone" class="form-label">
                      <i class="fas fa-phone-alt mr-1"></i>Téléphone *
                    </label>
                    <input
                      type="tel"
                      id="ownerPhone"
                      name="ownerPhone"
                      required
                      class="form-input"
                      placeholder="Numéro de téléphone"
                    />
                  </div>

                  <div class="form-group">
                    <label for="ownerEmail" class="form-label">
                      <i class="fas fa-envelope mr-1"></i>Email
                    </label>
                    <input
                      type="email"
                      id="ownerEmail"
                      name="ownerEmail"
                      class="form-input"
                      placeholder="Adresse email"
                    />
                  </div>

                  <div class="form-group">
                    <label for="ownerIdNumber" class="form-label">
                      <i class="fas fa-id-card mr-1"></i>CNI/Passeport *
                    </label>
                    <input
                      type="text"
                      id="ownerIdNumber"
                      name="ownerIdNumber"
                      required
                      class="form-input"
                      placeholder="Numéro de pièce d'identité"
                    />
                  </div>

                  <div class="form-group">
                    <label for="ownerProfession" class="form-label">
                      <i class="fas fa-briefcase mr-1"></i>Profession
                    </label>
                    <input
                      type="text"
                      id="ownerProfession"
                      name="ownerProfession"
                      class="form-input"
                      placeholder="Profession"
                    />
                  </div>
                </div>
              </div>

              <!-- Informations sur le vol -->
              <div class="form-group md:col-span-2 mt-6 pt-6 border-t border-gray-200">
                <h4 class="text-md font-semibold text-white bg-red-600 px-4 py-2 rounded-md mb-4">
                  <i class="fas fa-exclamation-triangle text-white mr-2"></i>Informations sur le vol
                </h4>
                <div class="grid grid-cols-1 gap-6">
                  <div class="form-group">
                    <label for="theftCircumstances" class="form-label">
                      <i class="fas fa-clipboard-list mr-1"></i>Circonstances du vol
                    </label>
                    <textarea
                      id="theftCircumstances"
                      name="theftCircumstances"
                      class="form-input"
                      rows="3"
                      placeholder="Décrivez les circonstances du vol (si connues)"
                    ></textarea>
                  </div>

                  <div class="form-group">
                    <label for="witnesses" class="form-label">
                      <i class="fas fa-users mr-1"></i>Témoins (noms et contacts)
                    </label>
                    <textarea
                      id="witnesses"
                      name="witnesses"
                      class="form-input"
                      rows="2"
                      placeholder="Noms et coordonnées des témoins éventuels"
                    ></textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label block mb-2">
                      <i class="fas fa-shield-alt mr-1"></i>Signalement à la police
                    </label>
                    <div class="space-x-4">
                      <label class="inline-flex items-center">
                        <input type="radio" name="policeReport" value="oui" class="form-radio">
                        <span class="ml-2">Oui</span>
                      </label>
                      <label class="inline-flex items-center">
                        <input type="radio" name="policeReport" value="non" class="form-radio" checked>
                        <span class="ml-2">Non</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Espace agent -->
              <div class="form-group md:col-span-2 mt-6 pt-6 border-t border-gray-200">
                <h4 class="text-md font-semibold text-white bg-purple-600 px-4 py-2 rounded-md mb-4">
                  <i class="fas fa-user-shield text-white mr-2"></i>Espace agent
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div class="form-group">
                    <label for="recordingAgent" class="form-label">
                      <i class="fas fa-user-edit mr-1"></i>Agent enregistreur *
                    </label>
                    <input
                      type="text"
                      id="recordingAgent"
                      name="recordingAgent"
                      class="form-input bg-gray-100"
                      disabled
                      value=""
                    />
                  </div>

                  <div class="form-group">
                    <label for="registrationDate" class="form-label">
                      <i class="far fa-calendar-alt mr-1"></i>Date d'enregistrement *
                    </label>
                    <input
                      type="date"
                      id="registrationDate"
                      name="registrationDate"
                      class="form-input bg-gray-100"
                      disabled
                    />
                  </div>

                  <div class="form-group">
                    <label for="caseStatus" class="form-label">
                      <i class="fas fa-folder-open mr-1"></i>Statut du dossier *
                    </label>
                    <select
                      id="caseStatus"
                      name="caseStatus"
                      class="form-input form-select"
                      required
                    >
                      <option value="">Sélectionner un statut</option>
                      <option value="enquete">Enquête en cours</option>
                      <option value="cloture">Clôturé</option>
                      <option value="classe">Classé sans suite</option>
                      <option value="resolu">Résolu</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="legion" class="form-label">
                      <i class="fas fa-map-marker-alt mr-1"></i>Légion *
                    </label>
                    <select
                      id="legion"
                      name="legion"
                      class="form-input form-select"
                      required
                    >
                      <option value="">Sélectionner une légion</option>
                      <option value="l1">CENTRE</option>
                      <option value="l2">LITTORAL</option>
                      <option value="l3">OUEST</option>
              <option value="l4">SUD</option>
              <option value="l5">NORD</option>
              <option value="l6">ADAMAOUA</option>
              <option value="l7">EST</option>
              <option value="l8">EXTREME-NORD</option>
              <option value="l9">NORD-OUEST</option>
              <option value="l10">SUD-OUEST</option>
              <option value="l11">GENDARMERIE MOBILE</option>
            </select>
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-1">Statut</label>
            <select id="status" class="form-input w-full" required>
              <option value="active">Recherché</option>
              <option value="recovered">Récupéré</option>
              <option value="closed">Dossier fermé</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1"
            >Description</label
          >
          <textarea
            id="description"
            class="form-input w-full"
            rows="2"
          ></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 font-medium mb-1"
              >Nom du propriétaire</label
            >
            <input
              type="text"
              id="ownerNameSecondary"
              class="form-input w-full"
              required
            />
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-1"
              >Téléphone secondaire</label
            >
            <input
              type="text"
              id="ownerSecondaryPhone"
              class="form-input w-full"
              required
            />
          </div>
          <div class="md:col-span-2">
            <label class="block text-gray-700 font-medium mb-1"
              >CNI secondaire</label
            >
            <input type="text" id="ownerSecondaryCni" class="form-input w-full" />
          </div>
          <div>
            <label class="block text-gray-700 font-medium mb-1"
              >Adresse secondaire</label
            >
            <input type="text" id="ownerSecondaryAddress" class="form-input w-full" />
          </div>
        </div>
        <div class="flex justify-between mt-6">
          <a
            href="list.html"
            class="btn bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300"
          >
            <i class="fas fa-arrow-left mr-1"></i> Retour
          </a>
          <button
            type="submit"
            class="btn bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold"
          >
            <i class="fas fa-save mr-1"></i> Enregistrer les modifications
          </button>
        </div>
      </form>

    </div>

    <script type="module" src="../assets/js/firebase-config.js"></script>
    <script type="module" src="../assets/js/auth.js"></script>
    <script type="module" src="../assets/js/utils.js"></script>
    <script>
      // Fonctions utilitaires pour gérer les champs conditionnels
      function toggleFoundFields() {
        const isFound = document.querySelector('input[name="found"]:checked')?.value === 'oui';
        const foundDateContainer = document.getElementById('foundDateContainer');
        const foundConditionContainer = document.getElementById('foundConditionContainer');
        const recoveryDelayContainer = document.getElementById('recoveryDelayContainer');
        
        if (foundDateContainer) foundDateContainer.classList.toggle('hidden', !isFound);
        if (foundConditionContainer) foundConditionContainer.classList.toggle('hidden', !isFound);
        if (recoveryDelayContainer) recoveryDelayContainer.classList.toggle('hidden', !isFound);
      }

      function toggleAntitheftFields() {
        const hasAntitheft = document.querySelector('input[name="antitheft_present"]:checked')?.value === 'present';
        const antitheftTypeContainer = document.getElementById('antitheftTypeContainer');
        if (antitheftTypeContainer) antitheftTypeContainer.classList.toggle('hidden', !hasAntitheft);
      }

      // Désactiver les champs non modifiables
      function disableNonEditableFields() {
        const nonEditableFields = [
          'registrationNumber', 'recordingAgent', 'registrationDate'
        ];
        
        nonEditableFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.disabled = true;
            field.classList.add('bg-gray-100');
          }
        });
      }

      // Initialisation des écouteurs d'événements
      function initEventListeners() {
        // Champs conditionnels
        document.querySelectorAll('input[name="found"]').forEach(radio => {
          radio.addEventListener('change', toggleFoundFields);
        });

        document.querySelectorAll('input[name="antitheft_present"]').forEach(radio => {
          radio.addEventListener('change', toggleAntitheftFields);
        });

        // Initialiser les états initiaux
        toggleFoundFields();
        toggleAntitheftFields();
        disableNonEditableFields();
      }

      // Initialiser quand le DOM est chargé
      document.addEventListener('DOMContentLoaded', initEventListeners);
    </script>
    <script type="module">
      import { doc, getDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Fonctions utilitaires
      function setValue(id, value) {
        const element = document.getElementById(id);
        if (!element) {
          console.warn(`Élément non trouvé: ${id}`);
          return;
        }
        
        if (element.type === 'checkbox') {
          element.checked = value;
        } else if (element.type === 'radio') {
          const radio = document.querySelector(`input[name="${element.name}"][value="${value}"]`);
          if (radio) radio.checked = true;
        } else if (element.tagName === 'SELECT' && element.multiple) {
          Array.from(element.options).forEach(option => {
            option.selected = value.includes(option.value);
          });
        } else {
          element.value = value || '';
        }
      }

      function setCheckboxGroup(name, values) {
        if (!values) return;
        const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
        checkboxes.forEach(checkbox => {
          checkbox.checked = values.includes(checkbox.value);
        });
      }

      function setRadioValue(name, value) {
        if (value === undefined || value === null) return;
        const radio = document.querySelector(`input[name="${name}"][value="${value}"]`);
        if (radio) radio.checked = true;
      }

      function showError(message) {
        const existing = document.getElementById('error-message');
        if (existing) existing.remove();
        
        const errorDiv = document.createElement('div');
        errorDiv.id = 'error-message';
        errorDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded';
        errorDiv.innerHTML = `<p>${message}</p>`;
        
        const form = document.getElementById('editVehicleForm');
        if (form) form.insertBefore(errorDiv, form.firstChild);
        
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function showSuccess(message) {
        const existing = document.getElementById('success-message');
        if (existing) existing.remove();
        
        const successDiv = document.createElement('div');
        successDiv.id = 'success-message';
        successDiv.className = 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4 rounded';
        successDiv.innerHTML = `<p>${message}</p>`;
        
        const form = document.getElementById('editVehicleForm');
        if (form) form.insertBefore(successDiv, form.firstChild);
        
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      // Récupère l'ID dans l'URL
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (!window.firebaseDb) {
        showError("Firebase n'est pas initialisé. Vérifiez l'ordre de chargement des scripts !");
        throw new Error("Firebase non initialisé");
      }
      const db = window.firebaseDb;

      // Fonction pour formater une date au format YYYY-MM-DD
      function formatDate(date) {
        if (!date) return '';
        const d = date.toDate ? date.toDate() : new Date(date.seconds * 1000);
        return d.toISOString().split('T')[0];
      }

      async function chargerVehicule() {
        if (!id) {
          showError("ID du véhicule manquant dans l'URL");
          return;
        }

        try {
          const snap = await getDoc(doc(db, "stolen_vehicles", id));
          
          if (!snap.exists()) {
            showError("Aucun véhicule trouvé avec cet ID");
            return;
          }

          const v = snap.data();
          console.log("Données du véhicule chargées:", v);

          // Désactiver les champs non modifiables
          disableNonEditableFields();
          
          // Informations de base
          setValue('registrationNumber', v.registration_number);
          setValue('theftDate', formatDate(v.theft_date));
          setValue('theftTime', v.theft_time || (v.theft_date ? new Date(v.theft_date.seconds * 1000).toTimeString().slice(0,5) : ''));
          setValue('theftLocation', v.theft_location);
          
          // Type de véhicule (cases à cocher multiples)
          if (v.vehicle_types) {
            setCheckboxGroup('vehicleType', v.vehicle_types);
          }
          
          // Détails du véhicule
          setValue('make', v.make || '');
          setValue('model', v.model || '');
          setValue('year', v.year);
          setValue('color', v.color);
          setValue('licensePlate', v.license_plate);
          setValue('chassisNumber', v.chassis_number);
          setValue('engineNumber', v.engine_number);
          setValue('estimatedValue', v.estimated_value);
          setValue('administration', v.administration);
          
          // Type de zone et visibilité (groupes radio)
          setRadioValue('zoneType', v.zone_type || 'urbaine');
          setRadioValue('visibility', v.visibility || 'visible');
          
          // Antivol
          setRadioValue('antitheft_present', v.antitheft_present || 'non');
          if (v.antitheft_types) {
            setCheckboxGroup('antitheftType', v.antitheft_types);
          }
          
          // Véhicule retrouvé
          const isFound = v.found || (v.found_date || v.found_condition || v.found_delay);
          setRadioValue('found', isFound ? 'oui' : 'non');
          
          if (isFound) {
            setValue('foundDate', formatDate(v.found_date));
            setValue('foundCondition', v.found_condition || '');
            setValue('foundDelay', v.found_delay || '');
          }
          
          // Caractéristiques distinctives
          setValue('distinctiveFeatures', v.distinctive_features || '');
          
          // Informations du propriétaire
          if (v.owner) {
            setValue('ownerLastName', v.owner.last_name || '');
            setValue('ownerFirstName', v.owner.first_name || '');
            setValue('ownerAddress', v.owner.address || '');
            setValue('ownerPhone', v.owner.phone || '');
            setValue('ownerEmail', v.owner.email || '');
            setValue('ownerIdNumber', v.owner.id_number || '');
            setValue('ownerProfession', v.owner.profession || '');
          }
          
          // Informations sur le vol
          setValue('theftCircumstances', v.theft_circumstances || '');
          setValue('witnesses', v.witnesses || '');
          // Radios Oui/Non pour signalement à la police
          setRadioValue('policeReport', v.reported_to_police ? 'oui' : 'non');
          
          // Espace agent (champs en lecture seule)
          setValue('recordingAgent', v.recording_agent || '');
          setValue('registrationDate', formatDate(v.registration_date) || '');
          setValue('caseStatus', v.case_status || 'enquete');
          setValue('agentObservations', v.agent_observations || '');
          
          // Champs hérités (pour compatibilité)
          // caseNumber n'existe pas dans ce formulaire d'édition
          setValue('legion', v.legion || '');
          setValue('status', v.status || 'active');
          setValue('description', v.description || '');
          
          // Certains champs (assurance, enquête, dernière localisation, récompense, notes)
          // ne sont pas présents dans ce formulaire d'édition, on ne tente donc pas
          // de les remplir ici pour éviter les avertissements.
          
          // Mettre à jour les champs conditionnels
          toggleFoundFields();
          toggleAntitheftFields();
          
        } catch (error) {
          console.error("Erreur lors du chargement du véhicule:", error);
          alert("Une erreur est survenue lors du chargement des données du véhicule.");
        }
      }
      chargerVehicule();

      // Fonction utilitaire pour obtenir la valeur d'un champ
      function getVal(id) {
        const el = document.getElementById(id);
        if (!el) return '';
        if (el.type === 'checkbox') return el.checked;
        if (el.type === 'radio') return document.querySelector(`input[name="${el.name}"]:checked`)?.value || '';
        return el.value || '';
      }

      // Fonction pour obtenir les valeurs des cases à cocher
      function getCheckboxValues(name) {
        return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
      }

      // Fonction pour obtenir la valeur d'un bouton radio
      function getRadioValue(name) {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        return selected ? selected.value : '';
      }

      // Fonction utilitaire pour valider les champs requis
      function validateRequiredFields() {
        const requiredFields = [
          'registrationNumber', 'theftDate', 'theftLocation', 'make', 'model',
          'year', 'color', 'chassisNumber', 'ownerLastName', 'ownerFirstName',
          'ownerPhone', 'ownerIdNumber', 'recordingAgent',
          'registrationDate', 'caseStatus', 'vehicleType', 'hasAntitheft'
        ];
        
        let isValid = true;
        
        requiredFields.forEach(fieldId => {
          // Gestion spéciale pour les cases à cocher et boutons radio
          if (fieldId === 'vehicleType') {
            const checked = document.querySelectorAll('input[name="vehicleType"]:checked').length > 0;
            if (!checked) {
              const container = document.querySelector('.form-group:has(input[name="vehicleType"])');
              if (container) container.classList.add('border-red-500', 'p-2', 'rounded-md');
              isValid = false;
            }
            return;
          }
          
          if (fieldId === 'hasAntitheft') {
            const checked = document.querySelector('input[name="hasAntitheft"]:checked');
            if (!checked) {
              const container = document.querySelector('.form-group:has(input[name="hasAntitheft"])');
              if (container) container.classList.add('border-red-500', 'p-2', 'rounded-md');
              isValid = false;
            }
            return;
          }
          
          const field = document.getElementById(fieldId);
          if (field && !field.disabled && !field.value.trim()) {
            // Mettre en surbrillance le champ manquant
            field.classList.add('border-red-500');
            isValid = false;
            
            // Faire défiler jusqu'au premier champ manquant
            if (isValid === false) {
              field.scrollIntoView({ behavior: 'smooth', block: 'center' });
              field.focus();
              isValid = null; // Empêche de faire défiler à nouveau
            }
          } else if (field) {
            field.classList.remove('border-red-500');
          }
        });
        
        return isValid;
      }

      // Gestionnaire de soumission du formulaire
      document.getElementById('editVehicleForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Afficher un indicateur de chargement
        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Enregistrement...';
        
        try {
          // Valider les champs requis
          if (!validateRequiredFields()) {
            showError('Veuillez remplir tous les champs obligatoires marqués d\'un astérisque (*)');
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
            return;
          }
          
          // Préparer les dates
          const theftDate = getVal('theftDate');
          const foundDate = getVal('foundDate');
          
          // Récupérer les valeurs du formulaire
          const vehicleData = {
            // Informations de base
            registration_number: getVal('registrationNumber'),
            theft_date: theftDate ? Timestamp.fromDate(new Date(theftDate)) : null,
            theft_time: getVal('theftTime'),
            theft_location: getVal('theftLocation'),
            
            // Type et détails du véhicule
            vehicle_types: getCheckboxValues('vehicleType'),
            make: getVal('make'),
            model: getVal('model'),
            year: parseInt(getVal('year')) || null,
            color: getVal('color'),
            license_plate: getVal('licensePlate')?.toUpperCase() || '',
            chassis_number: getVal('chassisNumber')?.toUpperCase() || '',
            engine_number: getVal('engineNumber') || '',
            estimated_value: parseFloat(getVal('estimatedValue')) || null,
            administration: getVal('administration') || '',
            
            // Localisation et sécurité
            zone_type: getVal('zoneType') || '',
            visibility: getVal('visibility') || '',
            antitheft_present: getRadioValue('antitheft_present') || 'non',
            antitheft_types: getCheckboxValues('antitheftType'),
            
            // État de retrouvaille
            found: getRadioValue('found') === 'oui',
            found_date: foundDate ? Timestamp.fromDate(new Date(foundDate)) : null,
            found_condition: getVal('foundCondition') || '',
            found_delay: getVal('foundDelay') || '',
            distinctive_features: getVal('distinctiveFeatures') || '',
            
            // Propriétaire
            owner: {
              last_name: getVal('ownerLastName') || '',
              first_name: getVal('ownerFirstName') || '',
              full_name: `${getVal('ownerFirstName')} ${getVal('ownerLastName')}`.trim(),
              address: getVal('ownerAddress') || '',
              phone: getVal('ownerPhone') || '',
              email: getVal('ownerEmail') || '',
              id_number: getVal('ownerIdNumber') || '',
              profession: getVal('ownerProfession') || ''
            },
            
            // Circonstances du vol
            theft_circumstances: getVal('theftCircumstances'),
            witnesses: getVal('witnesses'),
            // Radios Oui/Non pour signalement à la police
            reported_to_police: getRadioValue('policeReport') === 'oui',
            
            // Espace agent
            recording_agent: getVal('recordingAgent') || '',
            registration_date: getVal('registrationDate') ? 
              Timestamp.fromDate(new Date(getVal('registrationDate'))) : 
              Timestamp.now(),
            case_status: getVal('caseStatus') || 'enquete',
            agent_observations: getVal('agentObservations') || '',
            
            // Informations supplémentaires
            case_number: getVal('caseNumber') || '',
            legion: getVal('legion') || '',
            description: getVal('description') || '',
            status: getVal('caseStatus') === 'resolu' ? 'recovered' : 
                   (getVal('caseStatus') === 'clos' ? 'closed' : 'active'),
            
            // Nouveaux champs ajoutés
            // Champs avancés (assurance, enquête, dernière localisation, récompense, notes)
            // non exposés dans ce formulaire d'édition : on ne les modifie pas ici.
            
            // Métadonnées
            updated_at: Timestamp.now()
          };
          
          // Mettre à jour le document dans Firestore
          await updateDoc(doc(db, 'stolen_vehicles', id), vehicleData);
          
          // Afficher un message de succès
          showSuccess('Véhicule mis à jour avec succès ! Redirection en cours...');
          
          // Désactiver le formulaire après une mise à jour réussie
          document.querySelectorAll('#editVehicleForm input, #editVehicleForm select, #editVehicleForm textarea, #editVehicleForm button')
            .forEach(el => el.disabled = true);
          
          // Rediriger vers la liste après un court délai
          setTimeout(() => {
            window.location.href = 'list.html';
          }, 2000);
          
        } catch (error) {
          console.error('Erreur lors de la mise à jour du véhicule:', error);
          let errorMessage = 'Une erreur est survenue lors de la mise à jour du véhicule.';
          
          // Messages d'erreur plus spécifiques
          if (error.code === 'permission-denied') {
            errorMessage = 'Erreur d\'autorisation : Vous n\'avez pas les droits nécessaires pour effectuer cette action.';
          } else if (error.code === 'unavailable') {
            errorMessage = 'Erreur de connexion : Impossible de se connecter au serveur. Vérifiez votre connexion Internet.';
          } else if (error.code === 'not-found') {
            errorMessage = 'Erreur : Le véhicule que vous essayez de modifier n\'existe pas ou a été supprimé.';
          }
          
          showError(errorMessage);
          
          // Faire défiler vers le haut pour afficher le message d'erreur
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
        } finally {
          // Réactiver le bouton dans tous les cas
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonText;
        }
      });
    </script>
    </main>
  </body>
</html>
